var app = angular.module('app', ['ngRoute', 'ui.bootstrap', 'ngTagsInput']);

app.config(function ($routeProvider) {
    $routeProvider.when('/login', {
        templateUrl: 'templates/login.html',
        controller: 'loginController'
    }).when('/home', {
        templateUrl: 'templates/home.html',
        controller: 'homeController'
    }).otherwise({
        redirectTo: '/home'
    });
}).run(function ($rootScope, $location) {
    $rootScope.$on("$routeChangeStart", function () {
        if ($rootScope.loggedInUser == null) {
            $location.path("/login");
        }
    });
});;
app.controller('appController', function ($scope) {
    $scope.userName = 'Dan Thomas';
});

app.service('backendService', function ($http) {

    this.post = function (url, data, success, error) {

        $http({
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            url: 'http://localhost:3000/api/login',
            data: JSON.stringify({ accountName: accountName, password: password })
        }).success(function (responseData) {
            if (responseData.success) {
                $rootScope.loggedInUser = accountName;
                $location.url('/home');
            } else {
                callback({ success: false, errorMessage: 'Username & Password not recognised.' });
            }
        }).error(function () {
            callback({ success: false, errorMessage: 'System unavailable.' });
        });
    };

    return this;
});
app.controller('homeController', function ($scope, $http) {

    $scope.required = true;
    $scope.startDate = new Date();
    $scope.duration = new Date();

    $scope.startDate.setMinutes(0);
    $scope.startDate.setSeconds(0);

    $scope.duration.setHours(1);
    $scope.duration.setMinutes(0);
    $scope.duration.setSeconds(0);

    $scope.open = function ($event) {

        $event.preventDefault();
        $event.stopPropagation();

        $scope.opened = true;
    };

    $scope.submit = function(isValid) {

    };

    $scope.loadTags = function (query) {
        return $http.get('tags.json');
    };
});

app.directive('durationRange', function () {
    return {
        require: 'ngModel',
        link: function (scope, element, attrs, ngModel) {
            ngModel.$validators.durationRangeValidator = function (value, other) {
                console.log(value);
                console.log(other);
                return value.getHours() < 6;
            }
        }
    }
});

app.directive('datepickerPopup', function (dateFilter, datepickerPopupConfig) {
    return {
        restrict: 'A',
        priority: 1,
        require: 'ngModel',
        link: function (scope, element, attr, ngModel) {
            var dateFormat = attr.datepickerPopup || datepickerPopupConfig.datepickerPopup;
            ngModel.$formatters.push(function (value) {
                return dateFilter(value, dateFormat);
            });
        }
    };
});
app.controller('loginController', function ($scope, loginService) {

    loginService.init();

    $scope.model = {
        username: 'thomasd',
        password: 'password',
        login: function (isValid) {
            console.log(isValid);
            if (isValid) {
                loginService.login($scope.model.username, $scope.model.password, function (ret) {
                    if (ret.success) {
                        console.log('suceess');
                    } else {
                        $scope.model.errorMessage = ret.errorMessage;
                    }
                });

            }
        }
    };
});

app.service('loginService', function ($http, $location, $rootScope) {

    this.init = function() {
        $rootScope.loggedInUser = null;
    };

    this.login = function (accountName, password, callback) {

        if (accountName === '' || password === '') {
            callback({ success: false, errorMessage: 'Please enter a Username & Password.' });
        } else {

            $http({
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                url: 'http://localhost:3000/api/login',
                data: JSON.stringify({ accountName: accountName, password: password })
            }).success(function (responseData) {
                if (responseData.success) {
                    $rootScope.loggedInUser = accountName;
                    $location.url('/home');
                } else {
                    callback({ success: false, errorMessage: 'Username & Password not recognised.' });
                }
            }).error(function () {
                callback({ success: false, errorMessage: 'System unavailable.' });
            });
        }
    };

    return this;
});